services:
  localstack:
    container_name: localstack-main
    image: localstack/localstack:latest
    ports:
      - "4566:4566"            # LocalStack Gateway
      - "4510-4559:4510-4559"  # External services port range
    environment:
      # Serviços AWS a serem emulados
      - SERVICES=s3,sqs,sns,dynamodb
      # Configurações gerais
      - DEBUG=0
      # Configuração para permitir CORS
      - EXTRA_CORS_ALLOWED_ORIGINS=*
      - EXTRA_CORS_ALLOWED_HEADERS=*
      # Habilitar S3 path style e hostname externo
      - S3_SKIP_SIGNATURE_VALIDATION=1
      - HOSTNAME_EXTERNAL=localhost
    networks:
      - localstack-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  backend:
    container_name: flutter-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - AWS_ENDPOINT=http://localstack:4566
      - PUBLIC_LOCALSTACK_URL=http://10.0.2.2:4566
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - SQS_QUEUE_URL=http://localstack:4566/000000000000/shopping-tasks-queue
      - SNS_TOPIC_ARN=arn:aws:sns:us-east-1:000000000000:shopping-notifications
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - localstack-network
    restart: unless-stopped

  init-resources:
    container_name: localstack-init
    image: localstack/localstack:latest
    environment:
      - AWS_ENDPOINT_URL=http://localstack:4566
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    networks:
      - localstack-network
    depends_on:
      localstack:
        condition: service_healthy
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Inicializando recursos AWS no LocalStack..."
        sleep 3
        
        echo "Criando bucket S3..."
        aws --endpoint-url=http://localstack:4566 s3 mb s3://shopping-images 2>/dev/null || echo "     Bucket já existe"
        aws --endpoint-url=http://localstack:4566 s3api put-bucket-acl --bucket shopping-images --acl public-read 2>/dev/null
        
        echo "Criando fila SQS..."
        aws --endpoint-url=http://localstack:4566 sqs create-queue --queue-name shopping-tasks-queue 2>/dev/null || echo "     Fila já existe"
        
        echo "Criando tópico SNS..."
        aws --endpoint-url=http://localstack:4566 sns create-topic --name shopping-notifications 2>/dev/null || echo "     Tópico já existe"
        
        echo "Criando tabela DynamoDB..."
        aws --endpoint-url=http://localstack:4566 dynamodb create-table \
          --table-name ShoppingTasks \
          --attribute-definitions AttributeName=id,AttributeType=S AttributeName=createdAt,AttributeType=N \
          --key-schema AttributeName=id,KeyType=HASH AttributeName=createdAt,KeyType=RANGE \
          --billing-mode PAY_PER_REQUEST 2>/dev/null || echo "     Tabela já existe"
        
        echo "Recursos criados com sucesso!"
        echo "Listando recursos..."
        aws --endpoint-url=http://localstack:4566 s3 ls
        aws --endpoint-url=http://localstack:4566 dynamodb list-tables
    restart: "no"

networks:
  localstack-network:
    driver: bridge
